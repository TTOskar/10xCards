{% extends 'base.html.twig' %}

{% block title %}Generowanie fiszek przez AI - 10xCards{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block body %}
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Generowanie fiszek przez AI</h1>

        {# Limits display #}
        <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
            <h2 class="text-xl font-semibold mb-4">Twoje limity</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Pozostałe znaki</p>
                    <p class="text-2xl font-bold">{{ user_limits.remainingChars }}</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Pozostałe żądania/min</p>
                    <p class="text-2xl font-bold">{{ user_limits.remainingRequestsPerMin }}</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Pozostałe fiszki/dzień</p>
                    <p class="text-2xl font-bold">{{ user_limits.remainingFlashcardsToday }}</p>
                </div>
            </div>
        </div>

        {# Generation form #}
        <div class="bg-white p-6 rounded-lg shadow-sm"
             data-controller="form-validation"
             data-form-validation-min-length-value="1000"
             data-form-validation-max-length-value="10000">
            
            {{ form_start(form, {'attr': {'class': 'space-y-6'}}) }}
                <div class="mb-6">
                    {{ form_label(form.input_text, 'Tekst do przetworzenia', {'label_attr': {
                        'class': 'block mb-2 text-sm font-medium text-gray-900'
                    }}) }}
                    
                    {{ form_widget(form.input_text, {
                        'attr': {
                            'class': 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5',
                            'data-form-validation-target': 'input',
                            'data-action': 'input->form-validation#onInput'
                        }
                    }) }}

                    {# Character count #}
                    <div class="mt-2 flex justify-between items-center">
                        <span class="text-sm text-gray-500" data-form-validation-target="charCount">0/10000</span>
                        <span class="text-sm text-red-500 hidden" data-form-validation-target="errorMessage"></span>
                    </div>

                    {{ form_errors(form.input_text, {'attr': {'class': 'text-red-500 text-sm mt-1'}}) }}
                </div>

                <button type="submit" 
                        data-form-validation-target="submitButton"
                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    Generuj fiszki
                </button>
            {{ form_end(form) }}
        </div>

        {# Progress indicator #}
        <div data-controller="progress-indicator"
             {% if job_id is defined %}data-progress-indicator-job-id-value="{{ job_id }}"{% endif %}
             class="mt-8">
            <div data-progress-indicator-target="progress" class="hidden">
                <div class="mb-2 flex justify-between">
                    <span data-progress-indicator-target="status" class="text-sm text-gray-600">
                        Generowanie fiszek...
                    </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div data-progress-indicator-target="progressBar"
                         class="bg-blue-600 h-2.5 rounded-full"
                         style="width: 0%">
                    </div>
                </div>
            </div>
        </div>

        {# Flash messages container #}
        <div class="flash-messages mt-4"></div>

        {# Generated flashcards section #}
        {% if generated_flashcards is defined and generated_flashcards|length > 0 %}
            <div class="mt-8" 
                 data-controller="flashcard-actions"
                 {% if job_id is defined %}data-flashcard-actions-job-id-value="{{ job_id }}"{% endif %}>
                
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Wygenerowane fiszki</h2>
                    <div class="space-x-2">
                        <button type="button"
                                data-flashcard-actions-target="acceptAll"
                                data-action="click->flashcard-actions#acceptAll"
                                class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5">
                            Akceptuj wszystkie
                        </button>
                        <button type="button"
                                data-flashcard-actions-target="rejectAll"
                                data-action="click->flashcard-actions#rejectAll"
                                class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5">
                            Odrzuć wszystkie
                        </button>
                        <button type="button"
                                data-flashcard-actions-target="saveSelected"
                                data-action="click->flashcard-actions#saveSelected"
                                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5">
                            Zapisz wybrane
                        </button>
                    </div>
                </div>

                <div class="grid gap-4">
                    {% for flashcard in generated_flashcards %}
                        <div class="p-4 bg-white rounded-lg shadow-sm transition-all duration-200 
                                  hover:shadow-md relative {% if flashcard.status == 'accepted' %}border-l-4 border-green-500{% elseif flashcard.status == 'rejected' %}border-l-4 border-red-500{% endif %}"
                             data-flashcard-actions-target="flashcard"
                             data-flashcard-id="{{ flashcard.id }}">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">{{ flashcard.front }}</h3>
                                    <p class="mt-2 text-gray-600">{{ flashcard.back }}</p>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <button type="button"
                                            data-action="click->flashcard-actions#accept"
                                            class="text-green-700 hover:bg-green-100 p-2 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </button>
                                    <a href="{{ path('ai_flashcard_edit', {'flashcardId': flashcard.id}) }}"
                                       class="text-blue-700 hover:bg-blue-100 p-2 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </a>
                                    <button type="button"
                                            data-action="click->flashcard-actions#reject"
                                            class="text-red-700 hover:bg-red-100 p-2 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('form-validation') }}
    {{ encore_entry_script_tags('progress-indicator') }}
    {{ encore_entry_script_tags('flashcard-actions') }}
{% endblock %} 